# 1 "hxhxmacrohost_HostToCompilerRpc.ml"
(* Generated by reflaxe.ocaml (WIP) *)
(* Haxe type: hxhxmacrohost.HostToCompilerRpc *)

let __reflaxe_ocaml__ = ()

type t = { __hx_type : Obj.t }

let create = fun () -> let self = ({ __hx_type = HxType.class_ "hxhxmacrohost.HostToCompilerRpc" } : t) in (
  ignore ();
  self
)

let __empty = fun () -> ({ __hx_type = HxType.class_ "hxhxmacrohost.HostToCompilerRpc" } : t)

let isTrueEnv = fun name -> try let v = HxSys.getEnv name in (
  ignore (if v == Obj.magic (HxRuntime.hx_null) then raise (HxRuntime.Hx_return (Obj.repr false)) else ());
  let t = HxString.toLowerCase (StringTools.trim v) () in HxString.equals t "1" || HxString.equals t "true" || HxString.equals t "yes"
) with
  | HxRuntime.Hx_return __ret_1 -> Obj.obj __ret_1

let writeTraceLine = fun msg -> try (
  ignore (let __obj_2 = Sys_io_Stdio.stderr () in __obj_2.writeString (Obj.magic __obj_2) (HxString.toStdString msg ^ "\n") (Obj.magic (HxRuntime.hx_null)));
  let __obj_3 = Sys_io_Stdio.stderr () in __obj_3.flush (Obj.magic __obj_3) ()
) with
  | HxRuntime.Hx_break -> raise (HxRuntime.Hx_break)
  | HxRuntime.Hx_continue -> raise (HxRuntime.Hx_continue)
  | HxRuntime.Hx_return __ret_4 -> raise (HxRuntime.Hx_return __ret_4)
  | HxRuntime.Hx_exception (__exn_v_5, __exn_tags_6) -> if true then let _hx = (__exn_v_5 : Obj.t) in (
    ignore _hx;
    ()
  ) else HxRuntime.hx_throw_typed __exn_v_5 __exn_tags_6
  | __exn_7 -> if true then let _hx = (Obj.repr __exn_7 : Obj.t) in (
    ignore _hx;
    ()
  ) else raise (__exn_7)

let traceEnabled = fun () -> let tempResult = ref false in let v = HxSys.getEnv "HXHX_MACRO_HOST_TRACE" in (
  ignore (if v == Obj.magic (HxRuntime.hx_null) then let __assign_8 = false in (
    tempResult := __assign_8;
    __assign_8
  ) else let t = HxString.toLowerCase (StringTools.trim v) () in let __assign_9 = HxString.equals t "1" || HxString.equals t "true" || HxString.equals t "yes" in (
    tempResult := __assign_9;
    __assign_9
  ));
  !tempResult
)

let summarizeTail = fun tail -> try (
  ignore (if tail == Obj.magic (HxRuntime.hx_null) || HxString.length tail = 0 then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
  try let m = Hxhxmacrohost_Protocol.kvParse tail in let keys = HxArray.create () in let k = HxIterator.of_array (HxMap.keys_string m) in (
    ignore (while (let __iter_10 = k in fun () -> HxIterator.hasNext __iter_10) () do ignore (let k2 = (let __iter_11 = k in fun () -> HxIterator.next __iter_11) () in HxArray.push keys k2) done);
    raise (HxRuntime.Hx_return (Obj.repr ("keys=" ^ HxString.toStdString (HxArray.join keys "," (fun x -> x)))))
  ) with
    | HxRuntime.Hx_break -> raise (HxRuntime.Hx_break)
    | HxRuntime.Hx_continue -> raise (HxRuntime.Hx_continue)
    | HxRuntime.Hx_return __ret_12 -> raise (HxRuntime.Hx_return __ret_12)
    | HxRuntime.Hx_exception (__exn_v_13, __exn_tags_14) -> if true then let _hx = (__exn_v_13 : Obj.t) in (
      ignore _hx;
      raise (HxRuntime.Hx_return (Obj.repr ("len=" ^ string_of_int (HxString.length tail))))
    ) else HxRuntime.hx_throw_typed __exn_v_13 __exn_tags_14
    | __exn_15 -> if true then let _hx = (Obj.repr __exn_15 : Obj.t) in (
      ignore _hx;
      raise (HxRuntime.Hx_return (Obj.repr ("len=" ^ string_of_int (HxString.length tail))))
    ) else raise (__exn_15)
) with
  | HxRuntime.Hx_return __ret_16 -> Obj.obj __ret_16

let safeReadLine = fun () -> try try raise (HxRuntime.Hx_return (Obj.repr (try input_line stdin with End_of_file -> Obj.magic (HxRuntime.hx_null)))) with
  | HxRuntime.Hx_break -> raise (HxRuntime.Hx_break)
  | HxRuntime.Hx_continue -> raise (HxRuntime.Hx_continue)
  | HxRuntime.Hx_return __ret_28 -> raise (HxRuntime.Hx_return __ret_28)
  | HxRuntime.Hx_exception (__exn_v_29, __exn_tags_30) -> if true then let _hx = (__exn_v_29 : Obj.t) in (
    ignore _hx;
    raise (HxRuntime.Hx_return (Obj.repr (Obj.magic (HxRuntime.hx_null))))
  ) else HxRuntime.hx_throw_typed __exn_v_29 __exn_tags_30
  | __exn_31 -> if true then let _hx = (Obj.repr __exn_31 : Obj.t) in (
    ignore _hx;
    raise (HxRuntime.Hx_return (Obj.repr (Obj.magic (HxRuntime.hx_null))))
  ) else raise (__exn_31) with
  | HxRuntime.Hx_return __ret_32 -> Obj.obj __ret_32

let nextId = ref (-1 : int)

let call = fun hx_method tail -> let id = let __old_17 = !nextId in let __new_18 = HxInt.add __old_17 (-1) in (
  ignore (nextId := __new_18);
  __old_17
) in (
  ignore (if traceEnabled () then ignore (let tempString = ref "" in (
    ignore (if tail == Obj.magic (HxRuntime.hx_null) || HxString.length tail = 0 then let __assign_19 = "" in (
      tempString := __assign_19;
      __assign_19
    ) else let __assign_20 = " " ^ HxString.toStdString (summarizeTail tail) in (
      tempString := __assign_20;
      __assign_20
    ));
    writeTraceLine (("[hxhx macro host rpc] -> " ^ HxString.toStdString hx_method) ^ HxString.toStdString (!tempString))
  )) else ());
  let tempString1 = ref "" in (
    ignore (if tail == Obj.magic (HxRuntime.hx_null) || HxString.length tail = 0 then let __assign_21 = ((("req " ^ string_of_int id) ^ " ") ^ HxString.toStdString hx_method) ^ "\n" in (
      tempString1 := __assign_21;
      __assign_21
    ) else let __assign_22 = ((((("req " ^ string_of_int id) ^ " ") ^ HxString.toStdString hx_method) ^ " ") ^ HxString.toStdString tail) ^ "\n" in (
      tempString1 := __assign_22;
      __assign_22
    ));
    ignore (print_string (HxString.toStdString (!tempString1)));
    ignore (let __obj_23 = Sys_io_Stdio.stdout () in __obj_23.flush (Obj.magic __obj_23) ());
    let out = ref "" in (
      ignore (try while true do try ignore (let line = safeReadLine () in (
        ignore (if line == Obj.magic (HxRuntime.hx_null) then ignore (HxType.hx_throw_typed_rtti (Obj.repr "macro host: unexpected EOF while waiting for compiler response") ["Dynamic"; "String"]) else ());
        let trimmed = StringTools.trim line in (
          ignore (if HxString.length trimmed = 0 then raise (HxRuntime.Hx_continue) else ());
          ignore (if StringTools.startsWith trimmed "req " then ignore (HxType.hx_throw_typed_rtti (Obj.repr ("macro host: received unexpected compiler request while waiting for reverse response: " ^ HxString.toStdString trimmed)) ["Dynamic"; "String"]) else ());
          ignore (if not (StringTools.startsWith trimmed "res ") then ignore (HxType.hx_throw_typed_rtti (Obj.repr ("macro host: malformed reverse response: " ^ HxString.toStdString trimmed)) ["Dynamic"; "String"]) else ());
          let parts = Hxhxmacrohost_Protocol.splitN trimmed 3 in let rid = Std.parseInt (HxArray.get parts 1) in (
            ignore (if rid == HxRuntime.hx_null || not (let __nullable_24 = rid in if __nullable_24 == HxRuntime.hx_null then false else Obj.obj __nullable_24 = id) then ignore (HxType.hx_throw_typed_rtti (Obj.repr ("macro host: reverse response id mismatch: " ^ HxString.toStdString trimmed)) ["Dynamic"; "String"]) else ());
            let status = HxArray.get parts 2 in let respTail = HxArray.get parts 3 in (
              ignore (if HxString.equals status "ok" then ignore ((
                ignore (if traceEnabled () then ignore (writeTraceLine (("[hxhx macro host rpc] <- " ^ HxString.toStdString hx_method) ^ " ok")) else ());
                ignore (let __assign_25 = Hxhxmacrohost_Protocol.kvGet respTail "v" in (
                  out := __assign_25;
                  __assign_25
                ));
                raise (HxRuntime.Hx_break)
              )) else ());
              let msg2 = Hxhxmacrohost_Protocol.kvGet respTail "m" in let pos = Hxhxmacrohost_Protocol.kvGet respTail "p" in (
                ignore (if traceEnabled () then ignore (writeTraceLine (("[hxhx macro host rpc] <- " ^ HxString.toStdString hx_method) ^ " err")) else ());
                let tempError = ref "" in (
                  ignore (if pos != Obj.magic (HxRuntime.hx_null) && HxString.length pos > 0 then let __assign_26 = ((("compiler: " ^ HxString.toStdString msg2) ^ " (") ^ HxString.toStdString pos) ^ ")" in (
                    tempError := __assign_26;
                    __assign_26
                  ) else let __assign_27 = "compiler: " ^ HxString.toStdString msg2 in (
                    tempError := __assign_27;
                    __assign_27
                  ));
                  HxType.hx_throw_typed_rtti (Obj.repr (!tempError)) ["Dynamic"; "String"]
                )
              )
            )
          )
        )
      )) with
        | HxRuntime.Hx_continue -> () done with
        | HxRuntime.Hx_break -> ());
      !out
    )
  )
)