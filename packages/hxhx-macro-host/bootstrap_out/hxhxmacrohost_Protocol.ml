# 1 "hxhxmacrohost_Protocol.ml"
(* Generated by reflaxe.ocaml (WIP) *)
(* Haxe type: hxhxmacrohost.Protocol *)

let __reflaxe_ocaml__ = ()

type t = { __hx_type : Obj.t }

let create = fun () -> let self = ({ __hx_type = HxType.class_ "hxhxmacrohost.Protocol" } : t) in (
  ignore ();
  self
)

let __empty = fun () -> ({ __hx_type = HxType.class_ "hxhxmacrohost.Protocol" } : t)

let escapePayload = fun s -> try (
  ignore (if s == Obj.magic (HxRuntime.hx_null) then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
  HxArray.join (HxString.split (HxArray.join (HxString.split (HxArray.join (HxString.split (HxArray.join (HxString.split s "\\") "\\\\" (fun x -> x)) "\n") "\\n" (fun x -> x)) "\r") "\\r" (fun x -> x)) "\t") "\\t" (fun x -> x)
) with
  | HxRuntime.Hx_return __ret_1 -> Obj.obj __ret_1

let unescapePayload = fun s -> try (
  ignore (if s == Obj.magic (HxRuntime.hx_null) || HxString.length s = 0 then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
  let out = StringBuf.create () in let i = ref 0 in (
    ignore (try while !i < HxString.length s do try ignore (let c = HxString.charCodeAt s (!i) in (
      ignore (if (let __nullable_2 = c in if __nullable_2 == HxRuntime.hx_null then false else Obj.obj __nullable_2 = 92) && HxInt.add (!i) 1 < HxString.length s then ignore (let n = HxString.charCodeAt s (HxInt.add (!i) 1) in (
        ignore (if n == HxRuntime.hx_null then ignore (StringBuf.addChar out (let __nullable_int_3 = n in if __nullable_int_3 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_3)) else ignore (let __switch_5 = n in if __switch_5 == HxRuntime.hx_null then ignore (StringBuf.addChar out (let __nullable_int_4 = n in if __nullable_int_4 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_4)) else match Obj.obj __switch_5 with
          | 92 -> ignore (StringBuf.addChar out 92)
          | 110 -> ignore (StringBuf.addChar out 10)
          | 114 -> ignore (StringBuf.addChar out 13)
          | 116 -> ignore (StringBuf.addChar out 9)
          | _ -> ignore (StringBuf.addChar out (let __nullable_int_4 = n in if __nullable_int_4 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_4))));
        ignore (i := HxInt.add (!i) 2);
        raise (HxRuntime.Hx_continue)
      )) else ());
      ignore (StringBuf.addChar out (let __nullable_int_6 = c in if __nullable_int_6 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_6));
      let __old_7 = !i in let __new_8 = HxInt.add __old_7 1 in (
        ignore (i := __new_8);
        __old_7
      )
    )) with
      | HxRuntime.Hx_continue -> () done with
      | HxRuntime.Hx_break -> ());
    StringBuf.toString out ()
  )
) with
  | HxRuntime.Hx_return __ret_9 -> Obj.obj __ret_9

let encodeLen = fun label value -> let enc = escapePayload value in (((HxString.toStdString label ^ "=") ^ string_of_int (HxString.length enc)) ^ ":") ^ HxString.toStdString enc

let decodeLenValue = fun part -> try let eq = HxString.indexOf part "=" 0 in (
  ignore (if eq <= 0 then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
  let rest = HxString.substr part (HxInt.add eq 1) (-1) in let colon = HxString.indexOf rest ":" 0 in (
    ignore (if colon <= 0 then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
    let len = Std.parseInt (HxString.substr rest 0 colon) in (
      ignore (if len == HxRuntime.hx_null || (let __nullable_10 = len in let __nullable_11 = 0 in if __nullable_10 == HxRuntime.hx_null then false else Obj.obj __nullable_10 < __nullable_11) then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
      let payload = HxString.substr rest (HxInt.add colon 1) (-1) in (
        ignore (if let __nullable_12 = HxString.length payload in let __nullable_13 = len in if __nullable_13 == HxRuntime.hx_null then false else __nullable_12 < Obj.obj __nullable_13 then raise (HxRuntime.Hx_return (Obj.repr "")) else ());
        unescapePayload (HxString.substr payload 0 (let __nullable_int_14 = len in if __nullable_int_14 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_14))
      )
    )
  )
) with
  | HxRuntime.Hx_return __ret_15 -> Obj.obj __ret_15

let kvParse = fun tail -> try let out = HxMap.create_string () in (
  ignore (if tail == Obj.magic (HxRuntime.hx_null) || HxString.length tail = 0 then raise (HxRuntime.Hx_return (Obj.repr out)) else ());
  let i = ref 0 in (
    ignore (try while !i < HxString.length tail do try ignore ((
      ignore (try while true do try ignore (let tempRight = ref false in (
        ignore (let c = let __nullable_int_16 = HxString.charCodeAt tail (!i) in if __nullable_int_16 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_16 in let __assign_17 = c = 32 || c = 9 || c = 10 || c = 13 in (
          tempRight := __assign_17;
          __assign_17
        ));
        ignore (if not (!i < HxString.length tail && !tempRight) then raise (HxRuntime.Hx_break) else ());
        let __old_18 = !i in let __new_19 = HxInt.add __old_18 1 in (
          ignore (i := __new_19);
          __old_18
        )
      )) with
        | HxRuntime.Hx_continue -> () done with
        | HxRuntime.Hx_break -> ());
      ignore (if !i >= HxString.length tail then raise (HxRuntime.Hx_break) else ());
      let keyStart = !i in (
        ignore (try while !i < HxString.length tail do try ignore (let c = HxString.charCodeAt tail (!i) in let c2 = let __nullable_int_20 = c in if __nullable_int_20 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_20 in let tempRight1 = c2 = 32 || c2 = 9 || c2 = 10 || c2 = 13 in (
          ignore (if (let __nullable_21 = c in if __nullable_21 == HxRuntime.hx_null then false else Obj.obj __nullable_21 = 61) || tempRight1 then raise (HxRuntime.Hx_break) else ());
          let __old_22 = !i in let __new_23 = HxInt.add __old_22 1 in (
            ignore (i := __new_23);
            __old_22
          )
        )) with
          | HxRuntime.Hx_continue -> () done with
          | HxRuntime.Hx_break -> ());
        ignore (if !i >= HxString.length tail || not (let __nullable_24 = HxString.charCodeAt tail (!i) in if __nullable_24 == HxRuntime.hx_null then false else Obj.obj __nullable_24 = 61) then ignore ((
          ignore (try while true do try ignore (let tempBool = ref false in (
            ignore (let c = let __nullable_int_25 = HxString.charCodeAt tail (!i) in if __nullable_int_25 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_25 in let __assign_26 = c = 32 || c = 9 || c = 10 || c = 13 in (
              tempBool := __assign_26;
              __assign_26
            ));
            ignore (if not (!i < HxString.length tail && not (!tempBool)) then raise (HxRuntime.Hx_break) else ());
            let __old_27 = !i in let __new_28 = HxInt.add __old_27 1 in (
              ignore (i := __new_28);
              __old_27
            )
          )) with
            | HxRuntime.Hx_continue -> () done with
            | HxRuntime.Hx_break -> ());
          raise (HxRuntime.Hx_continue)
        )) else ());
        let key = HxString.substr tail keyStart (HxInt.sub (!i) keyStart) in (
          ignore (let __old_29 = !i in let __new_30 = HxInt.add __old_29 1 in (
            ignore (i := __new_30);
            __old_29
          ));
          let lenStart = !i in (
            ignore (try while true do try ignore (let tempRight2 = ref false in (
              ignore (let c = let __nullable_int_31 = HxString.charCodeAt tail (!i) in if __nullable_int_31 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_31 in let __assign_32 = c >= 48 && c <= 57 in (
                tempRight2 := __assign_32;
                __assign_32
              ));
              ignore (if not (!i < HxString.length tail && !tempRight2) then raise (HxRuntime.Hx_break) else ());
              let __old_33 = !i in let __new_34 = HxInt.add __old_33 1 in (
                ignore (i := __new_34);
                __old_33
              )
            )) with
              | HxRuntime.Hx_continue -> () done with
              | HxRuntime.Hx_break -> ());
            ignore (if !i >= HxString.length tail || not (let __nullable_35 = HxString.charCodeAt tail (!i) in if __nullable_35 == HxRuntime.hx_null then false else Obj.obj __nullable_35 = 58) then ignore ((
              ignore (try while true do try ignore (let tempBool1 = ref false in (
                ignore (let c = let __nullable_int_36 = HxString.charCodeAt tail (!i) in if __nullable_int_36 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_36 in let __assign_37 = c = 32 || c = 9 || c = 10 || c = 13 in (
                  tempBool1 := __assign_37;
                  __assign_37
                ));
                ignore (if not (!i < HxString.length tail && not (!tempBool1)) then raise (HxRuntime.Hx_break) else ());
                let __old_38 = !i in let __new_39 = HxInt.add __old_38 1 in (
                  ignore (i := __new_39);
                  __old_38
                )
              )) with
                | HxRuntime.Hx_continue -> () done with
                | HxRuntime.Hx_break -> ());
              raise (HxRuntime.Hx_continue)
            )) else ());
            let lenStr = HxString.substr tail lenStart (HxInt.sub (!i) lenStart) in let len = Std.parseInt lenStr in (
              ignore (let __old_40 = !i in let __new_41 = HxInt.add __old_40 1 in (
                ignore (i := __new_41);
                __old_40
              ));
              ignore (if len == HxRuntime.hx_null || (let __nullable_42 = len in let __nullable_43 = 0 in if __nullable_42 == HxRuntime.hx_null then false else Obj.obj __nullable_42 < __nullable_43) || HxInt.add (!i) (let __nullable_int_44 = len in if __nullable_int_44 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_44) > HxString.length tail then raise (HxRuntime.Hx_break) else ());
              let enc = HxString.substr tail (!i) (let __nullable_int_45 = len in if __nullable_int_45 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_45) in (
                ignore (i := HxInt.add (!i) (let __nullable_int_46 = len in if __nullable_int_46 == HxRuntime.hx_null then 0 else Obj.obj __nullable_int_46));
                let value = unescapePayload enc in HxMap.set_string out key value
              )
            )
          )
        )
      )
    )) with
      | HxRuntime.Hx_continue -> () done with
      | HxRuntime.Hx_break -> ());
    out
  )
) with
  | HxRuntime.Hx_return __ret_47 -> Obj.obj __ret_47

let kvGet = fun tail key -> let m = kvParse tail in let tempResult = ref "" in (
  ignore (if HxMap.exists_string m key then let __assign_48 = HxMap.get_string m key in (
    tempResult := __assign_48;
    __assign_48
  ) else let __assign_49 = "" in (
    tempResult := __assign_49;
    __assign_49
  ));
  !tempResult
)

let splitN = fun s n -> let head = HxArray.create () in let i = ref 0 in let start = ref 0 in (
  ignore (try while HxArray.length head < n && !i <= HxString.length s do try ignore ((
    ignore (if !i = HxString.length s || (let __nullable_50 = HxString.charCodeAt s (!i) in if __nullable_50 == HxRuntime.hx_null then false else Obj.obj __nullable_50 = 32) then ignore ((
      ignore (if !i > !start then ignore (HxArray.push head (HxString.substr s (!start) (HxInt.sub (!i) (!start)))) else ());
      ignore (while !i < HxString.length s && (let __nullable_51 = HxString.charCodeAt s (!i) in if __nullable_51 == HxRuntime.hx_null then false else Obj.obj __nullable_51 = 32) do ignore (let __old_52 = !i in let __new_53 = HxInt.add __old_52 1 in (
        ignore (i := __new_53);
        __old_52
      )) done);
      ignore (let __assign_54 = !i in (
        start := __assign_54;
        __assign_54
      ));
      raise (HxRuntime.Hx_continue)
    )) else ());
    let __old_55 = !i in let __new_56 = HxInt.add __old_55 1 in (
      ignore (i := __new_56);
      __old_55
    )
  )) with
    | HxRuntime.Hx_continue -> () done with
    | HxRuntime.Hx_break -> ());
  ignore (while HxArray.length head < n do ignore (HxArray.push head "") done);
  let tempString = ref "" in (
    ignore (if !start <= HxString.length s then let __assign_57 = HxString.substr s (!start) (-1) in (
      tempString := __assign_57;
      __assign_57
    ) else let __assign_58 = "" in (
      tempString := __assign_58;
      __assign_58
    ));
    ignore (HxArray.push head (!tempString));
    head
  )
)