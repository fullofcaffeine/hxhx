# 1 "haxe_CallStack.ml"
(* Generated by reflaxe.ocaml (WIP) *)
(* Haxe enum: haxe.StackItem *)

type stackitem =
| CFunction
| Module of string
| FilePos of Obj.t * string * int * Obj.t
| Method of string * string
| LocalFunction of Obj.t

(* Generated by reflaxe.ocaml (WIP) *)
(* Haxe type: haxe._CallStack.CallStack_Impl_ *)

let __reflaxe_ocaml__ = ()

let rec equalItems = fun item1 item2 -> let tempResult = ref false in (
  ignore (if item1 == Obj.magic (HxRuntime.hx_null) then if item2 == Obj.magic (HxRuntime.hx_null) then let __assign_13 = true in (
    tempResult := __assign_13;
    __assign_13
  ) else let __assign_14 = false in (
    tempResult := __assign_14;
    __assign_14
  ) else match let __enum_idx_71 = item1 in if __enum_idx_71 == HxRuntime.hx_null then -1 else match Obj.obj __enum_idx_71 with
    | CFunction -> 0
    | Module _ -> 1
    | FilePos (_, _, _, _) -> 2
    | Method (_, _) -> 3
    | LocalFunction _ -> 4 with
    | 0 -> if item2 == Obj.magic (HxRuntime.hx_null) then let __assign_15 = false in (
      tempResult := __assign_15;
      __assign_15
    ) else if (let __enum_idx_16 = item2 in if __enum_idx_16 == HxRuntime.hx_null then -1 else match Obj.obj __enum_idx_16 with
      | CFunction -> 0
      | Module _ -> 1
      | FilePos (_, _, _, _) -> 2
      | Method (_, _) -> 3
      | LocalFunction _ -> 4) = 0 then let __assign_17 = true in (
      tempResult := __assign_17;
      __assign_17
    ) else let __assign_18 = false in (
      tempResult := __assign_18;
      __assign_18
    )
    | 1 -> let _g = let __enum_param_20 = item1 in if __enum_param_20 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_20 with
      | Module __enum_param_19 -> __enum_param_19
      | _ -> failwith "Unexpected enum parameter" in if item2 == Obj.magic (HxRuntime.hx_null) then let __assign_21 = false in (
      tempResult := __assign_21;
      __assign_21
    ) else if (let __enum_idx_22 = item2 in if __enum_idx_22 == HxRuntime.hx_null then -1 else match Obj.obj __enum_idx_22 with
      | CFunction -> 0
      | Module _ -> 1
      | FilePos (_, _, _, _) -> 2
      | Method (_, _) -> 3
      | LocalFunction _ -> 4) = 1 then let _g1 = let __enum_param_24 = item2 in if __enum_param_24 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_24 with
      | Module __enum_param_23 -> __enum_param_23
      | _ -> failwith "Unexpected enum parameter" in let m2 = _g1 in let m1 = _g in let __assign_25 = HxString.equals m1 m2 in (
      tempResult := __assign_25;
      __assign_25
    ) else let __assign_26 = false in (
      tempResult := __assign_26;
      __assign_26
    )
    | 2 -> let _g = Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" (let __enum_param_28 = item1 in if __enum_param_28 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_28 with
      | FilePos (__enum_param_27, _, _, _) -> __enum_param_27
      | _ -> failwith "Unexpected enum parameter")) in let _g1 = let __enum_param_30 = item1 in if __enum_param_30 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_30 with
      | FilePos (_, __enum_param_29, _, _) -> __enum_param_29
      | _ -> failwith "Unexpected enum parameter" in let _g2 = let __enum_param_32 = item1 in if __enum_param_32 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_32 with
      | FilePos (_, _, __enum_param_31, _) -> __enum_param_31
      | _ -> failwith "Unexpected enum parameter" in let _g3 = let __enum_param_34 = item1 in if __enum_param_34 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_34 with
      | FilePos (_, _, _, __enum_param_33) -> __enum_param_33
      | _ -> failwith "Unexpected enum parameter" in if item2 == Obj.magic (HxRuntime.hx_null) then let __assign_35 = false in (
      tempResult := __assign_35;
      __assign_35
    ) else if (let __enum_idx_36 = item2 in if __enum_idx_36 == HxRuntime.hx_null then -1 else match Obj.obj __enum_idx_36 with
      | CFunction -> 0
      | Module _ -> 1
      | FilePos (_, _, _, _) -> 2
      | Method (_, _) -> 3
      | LocalFunction _ -> 4) = 2 then let _g4 = Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" (let __enum_param_38 = item2 in if __enum_param_38 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_38 with
      | FilePos (__enum_param_37, _, _, _) -> __enum_param_37
      | _ -> failwith "Unexpected enum parameter")) in let _g5 = let __enum_param_40 = item2 in if __enum_param_40 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_40 with
      | FilePos (_, __enum_param_39, _, _) -> __enum_param_39
      | _ -> failwith "Unexpected enum parameter" in let _g6 = let __enum_param_42 = item2 in if __enum_param_42 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_42 with
      | FilePos (_, _, __enum_param_41, _) -> __enum_param_41
      | _ -> failwith "Unexpected enum parameter" in let _g7 = let __enum_param_44 = item2 in if __enum_param_44 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_44 with
      | FilePos (_, _, _, __enum_param_43) -> __enum_param_43
      | _ -> failwith "Unexpected enum parameter" in let item3 = Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" _g4) in let file2 = _g5 in let line2 = _g6 in let col2 = _g7 in let col1 = _g3 in let line1 = _g2 in let file1 = _g1 in let item4 = Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" _g) in let __assign_45 = HxString.equals file1 file2 && line1 = line2 && (let __nullable_46 = col1 in let __nullable_47 = col2 in if __nullable_46 == HxRuntime.hx_null then __nullable_46 == HxRuntime.hx_null && __nullable_47 == HxRuntime.hx_null else not (__nullable_47 == HxRuntime.hx_null) && Obj.obj __nullable_46 = Obj.obj __nullable_47) && equalItems (Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" item4)) (Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" item3)) in (
      tempResult := __assign_45;
      __assign_45
    ) else let __assign_48 = false in (
      tempResult := __assign_48;
      __assign_48
    )
    | 3 -> let _g = let __enum_param_50 = item1 in if __enum_param_50 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_50 with
      | Method (__enum_param_49, _) -> __enum_param_49
      | _ -> failwith "Unexpected enum parameter" in let _g1 = let __enum_param_52 = item1 in if __enum_param_52 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_52 with
      | Method (_, __enum_param_51) -> __enum_param_51
      | _ -> failwith "Unexpected enum parameter" in if item2 == Obj.magic (HxRuntime.hx_null) then let __assign_53 = false in (
      tempResult := __assign_53;
      __assign_53
    ) else if (let __enum_idx_54 = item2 in if __enum_idx_54 == HxRuntime.hx_null then -1 else match Obj.obj __enum_idx_54 with
      | CFunction -> 0
      | Module _ -> 1
      | FilePos (_, _, _, _) -> 2
      | Method (_, _) -> 3
      | LocalFunction _ -> 4) = 3 then let _g2 = let __enum_param_56 = item2 in if __enum_param_56 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_56 with
      | Method (__enum_param_55, _) -> __enum_param_55
      | _ -> failwith "Unexpected enum parameter" in let _g3 = let __enum_param_58 = item2 in if __enum_param_58 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_58 with
      | Method (_, __enum_param_57) -> __enum_param_57
      | _ -> failwith "Unexpected enum parameter" in let class2 = _g2 in let method2 = _g3 in let method1 = _g1 in let class1 = _g in let __assign_59 = HxString.equals class1 class2 && HxString.equals method1 method2 in (
      tempResult := __assign_59;
      __assign_59
    ) else let __assign_60 = false in (
      tempResult := __assign_60;
      __assign_60
    )
    | 4 -> let _g = let __enum_param_62 = item1 in if __enum_param_62 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_62 with
      | LocalFunction __enum_param_61 -> __enum_param_61
      | _ -> failwith "Unexpected enum parameter" in if item2 == Obj.magic (HxRuntime.hx_null) then let __assign_63 = false in (
      tempResult := __assign_63;
      __assign_63
    ) else if (let __enum_idx_64 = item2 in if __enum_idx_64 == HxRuntime.hx_null then -1 else match Obj.obj __enum_idx_64 with
      | CFunction -> 0
      | Module _ -> 1
      | FilePos (_, _, _, _) -> 2
      | Method (_, _) -> 3
      | LocalFunction _ -> 4) = 4 then let _g1 = let __enum_param_66 = item2 in if __enum_param_66 == HxRuntime.hx_null then failwith "Unexpected enum parameter" else match Obj.obj __enum_param_66 with
      | LocalFunction __enum_param_65 -> __enum_param_65
      | _ -> failwith "Unexpected enum parameter" in let v2 = _g1 in let v1 = _g in let __assign_67 = let __nullable_68 = v1 in let __nullable_69 = v2 in if __nullable_68 == HxRuntime.hx_null then __nullable_68 == HxRuntime.hx_null && __nullable_69 == HxRuntime.hx_null else not (__nullable_69 == HxRuntime.hx_null) && Obj.obj __nullable_68 = Obj.obj __nullable_69 in (
      tempResult := __assign_67;
      __assign_67
    ) else let __assign_70 = false in (
      tempResult := __assign_70;
      __assign_70
    )
    | _ -> failwith "Non-exhaustive switch");
  !tempResult
)

let subtract = fun this1 stack -> let startIndex = ref (-1) in let i = ref (-1) in (
  ignore (try while true do try ignore ((
    ignore (if not ((let __old_3 = !i in let __new_4 = HxInt.add __old_3 1 in (
      ignore (i := __new_4);
      __new_4
    )) < HxArray.length this1) then raise (HxRuntime.Hx_break) else ());
    let _g = ref 0 in let _g1 = HxArray.length stack in (
      ignore (try while !_g < _g1 do try ignore (let j = let __old_5 = !_g in let __new_6 = HxInt.add __old_5 1 in (
        ignore (_g := __new_6);
        __old_5
      ) in if equalItems (HxEnum.box_if_needed "haxe.StackItem" (Obj.repr (HxArray.get this1 (!i)))) (HxEnum.box_if_needed "haxe.StackItem" (Obj.repr (HxArray.get stack j))) then ignore ((
        ignore (if !startIndex < 0 then ignore (let __assign_7 = !i in (
          startIndex := __assign_7;
          __assign_7
        )) else ());
        ignore (let __old_8 = !i in let __new_9 = HxInt.add __old_8 1 in (
          ignore (i := __new_9);
          __new_9
        ));
        if !i >= HxArray.length this1 then raise (HxRuntime.Hx_break) else ()
      )) else ignore (let __assign_10 = -1 in (
        startIndex := __assign_10;
        __assign_10
      ))) with
        | HxRuntime.Hx_continue -> () done with
        | HxRuntime.Hx_break -> ());
      if !startIndex >= 0 then raise (HxRuntime.Hx_break) else ()
    )
  )) with
    | HxRuntime.Hx_continue -> () done with
    | HxRuntime.Hx_break -> ());
  let tempResult = ref (Obj.magic ()) in (
    ignore (if !startIndex >= 0 then let __assign_11 = HxArray.slice this1 0 (!startIndex) in (
      tempResult := __assign_11;
      __assign_11
    ) else let __assign_12 = this1 in (
      tempResult := __assign_12;
      __assign_12
    ));
    !tempResult
  )
)

let rec itemToString = fun b s -> match s with
  | CFunction -> ignore (StringBuf.add b (Obj.repr "a C function"))
  | Module _p0 -> ignore (let _g = _p0 in let m = _g in (
    ignore (StringBuf.add b (Obj.repr "module "));
    StringBuf.add b (Obj.repr m)
  ))
  | FilePos (_p0, _p1, _p2, _p3) -> ignore (let _g = Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" _p0) in let _g1 = _p1 in let _g2 = _p2 in let _g3 = _p3 in let s2 = Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" _g) in let file = _g1 in let line = _g2 in let col = _g3 in (
    ignore (if s2 != Obj.magic (HxRuntime.hx_null) then ignore ((
      ignore (itemToString b (Obj.obj (HxEnum.unbox_or_obj "haxe.StackItem" s2)));
      StringBuf.add b (Obj.repr " (")
    )) else ());
    ignore (StringBuf.add b (Obj.repr file));
    ignore (StringBuf.add b (Obj.repr " line "));
    ignore (StringBuf.add b (Obj.repr line));
    ignore (if col != HxRuntime.hx_null then ignore ((
      ignore (StringBuf.add b (Obj.repr " column "));
      StringBuf.add b col
    )) else ());
    if s2 != Obj.magic (HxRuntime.hx_null) then ignore (StringBuf.add b (Obj.repr ")")) else ()
  ))
  | Method (_p0, _p1) -> ignore (let _g = _p0 in let _g1 = _p1 in let cname = _g in let meth = _g1 in let tempMaybeString = ref (Obj.magic ()) in (
    ignore (if cname == Obj.magic (HxRuntime.hx_null) then let __assign_72 = "<unknown>" in (
      tempMaybeString := __assign_72;
      __assign_72
    ) else let __assign_73 = cname in (
      tempMaybeString := __assign_73;
      __assign_73
    ));
    ignore (StringBuf.add b (Obj.repr (!tempMaybeString)));
    ignore (StringBuf.add b (Obj.repr "."));
    StringBuf.add b (Obj.repr meth)
  ))
  | LocalFunction _p0 -> ignore (let _g = _p0 in let n = _g in (
    ignore (StringBuf.add b (Obj.repr "local function #"));
    StringBuf.add b n
  ))

let toString = fun stack -> let b = StringBuf.create () in let _g = ref 0 in let _g1 = stack in (
  ignore (while !_g < HxArray.length _g1 do ignore (let s = HxArray.get _g1 (!_g) in (
    ignore (let __old_1 = !_g in let __new_2 = HxInt.add __old_1 1 in (
      ignore (_g := __new_2);
      __new_2
    ));
    ignore (StringBuf.add b (Obj.repr "\nCalled from "));
    itemToString b s
  )) done);
  StringBuf.toString b ()
)