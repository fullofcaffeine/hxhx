package reflaxe.ocaml.runtimegen;

#if (macro || reflaxe_runtime)

import haxe.io.Path;

import reflaxe.output.OutputManager;

typedef DuneProjectConfig = {
	final projectName:String;
	final exeName:String;
	final mainModuleId:Null<String>;
}

class DuneProjectEmitter {
	static inline final RUNTIME_LIB_NAME = "hx_runtime";

	public static function ocamlModuleNameFromHaxeModuleId(id:String):String {
		if (id == null || id.length == 0) return "Main";
		// OCaml module name is derived from filename; ensure leading uppercase.
		final first = id.charCodeAt(0);
		final isLower = first >= 97 && first <= 122;
		return isLower ? (String.fromCharCode(first - 32) + id.substr(1)) : id;
	}

	public static function defaultProjectName(outDir:String):String {
		final base = Path.withoutDirectory(Path.normalize(outDir));
		return sanitizeName(base.length > 0 ? base : "ocaml_app");
	}

	public static function defaultExeName(outDir:String):String {
		// Keep executable name lowercase to match dune conventions.
		return sanitizeName(defaultProjectName(outDir)).toLowerCase();
	}

	static function sanitizeName(name:String):String {
		final out = new StringBuf();
		for (i in 0...name.length) {
			final c = name.charCodeAt(i);
			final isAlphaNum = (c >= 97 && c <= 122) // a-z
				|| (c >= 65 && c <= 90) // A-Z
				|| (c >= 48 && c <= 57); // 0-9
			out.add(isAlphaNum ? String.fromCharCode(c) : "_");
		}
		var s = out.toString();
		if (s.length == 0) s = "ocaml_app";
		if (s.charCodeAt(0) >= 48 && s.charCodeAt(0) <= 57) {
			s = "_" + s;
		}
		return s;
	}

	public static function emit(output:OutputManager, cfg:DuneProjectConfig):Void {
		final projectName = cfg.projectName;
		final exeName = cfg.exeName;

		output.saveFile(".gitignore", "_build/\n*.install\n");

		output.saveFile("dune-project", [
			"(lang dune 3.10)",
			"(name " + projectName + ")",
			"",
			"; Generated by reflaxe.ocaml"
		].join("\n"));

		// Runtime library (M6): built from sources copied into `runtime/`.
		output.saveFile("runtime/dune", [
			"(library",
			" (name " + RUNTIME_LIB_NAME + ")",
			" (modules :standard))",
			"",
			"; Generated by reflaxe.ocaml"
		].join("\n"));

		output.saveFile("dune", [
			"(executable",
			" (name " + exeName + ")",
			" (modules :standard)",
			" (libraries " + RUNTIME_LIB_NAME + ")",
			" (modes (native exe) (byte exe)))",
			"",
			"; Generated by reflaxe.ocaml"
		].join("\n"));

		// Entry module: dune expects `<name>.ml` to exist for `(name ...)`.
		final mainModuleName = cfg.mainModuleId != null ? ocamlModuleNameFromHaxeModuleId(cfg.mainModuleId) : null;
		final entryBody = if (mainModuleName != null) {
			"let () = " + mainModuleName + ".main ()\n";
		} else {
			"let () = ()\n";
		}
		output.saveFile(exeName + ".ml", entryBody);
	}
}

#end
