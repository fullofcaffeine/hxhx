package reflaxe.ocaml.runtimegen;

#if (macro || reflaxe_runtime)

import haxe.io.Path;

import reflaxe.output.OutputManager;

typedef DuneProjectConfig = {
	final projectName:String;
	final exeName:String;
	final mainModuleId:Null<String>;
}

class DuneProjectEmitter {
	public static function defaultProjectName(outDir:String):String {
		final base = Path.withoutDirectory(Path.normalize(outDir));
		return sanitizeName(base.length > 0 ? base : "ocaml_app");
	}

	public static function defaultExeName(outDir:String):String {
		// Keep executable name lowercase to match dune conventions.
		return sanitizeName(defaultProjectName(outDir)).toLowerCase();
	}

	static function sanitizeName(name:String):String {
		final out = new StringBuf();
		for (i in 0...name.length) {
			final c = name.charCodeAt(i);
			final isAlphaNum = (c >= 97 && c <= 122) // a-z
				|| (c >= 65 && c <= 90) // A-Z
				|| (c >= 48 && c <= 57); // 0-9
			out.add(isAlphaNum ? String.fromCharCode(c) : "_");
		}
		var s = out.toString();
		if (s.length == 0) s = "ocaml_app";
		if (s.charCodeAt(0) >= 48 && s.charCodeAt(0) <= 57) {
			s = "_" + s;
		}
		return s;
	}

	public static function emit(output:OutputManager, cfg:DuneProjectConfig):Void {
		final projectName = cfg.projectName;
		final exeName = cfg.exeName;

		output.saveFile(".gitignore", "_build/\n*.install\n");

		output.saveFile("dune-project", [
			"(lang dune 3.10)",
			"(name " + projectName + ")",
			"",
			"; Generated by reflaxe.ocaml"
		].join("\n"));

		output.saveFile("dune", [
			"(executable",
			" (name " + exeName + ")",
			" (modules :standard)",
			" (modes (native exe) (byte exe)))",
			"",
			"; Generated by reflaxe.ocaml"
		].join("\n"));

		// Entry module: call Haxe `Main.main()` equivalent if available.
		final entryBody = if (cfg.mainModuleId != null) {
			"let () = " + cfg.mainModuleId + ".main ()\n";
		} else {
			"let () = ()\n";
		}
		output.saveFile("entry.ml", entryBody);
	}
}

#end
